server {
    listen 443 ssl;
    server_name financeher.ahmard.net;

    # SSL
#     ssl_certificate /etc/letsencrypt/live/financeher.ahmard.net/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/financeher.ahmard.net/privkey.pem;
#     include /etc/letsencrypt/options-ssl-nginx.conf;
#     ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Logging
    error_log /var/log/nginx/financeher.error.log warn;

    # === BACKEND: Laravel under /hydrogen ===
    location ^~ /hydrogen {
        access_log /var/log/nginx/backend.access.log;

        # Set root to Laravel public directory
        root /var/www/public;

        # Strip /hydrogen prefix and set new URI
        rewrite ^/hydrogen(/.*)$ $1 break;

        # Try static files first, then pass to index.php
        try_files $uri $uri/ @hydrogen_php;
    }

    # Named location for handling PHP files under /hydrogen
    location @hydrogen_php {
        include fastcgi_params;
        fastcgi_pass 192.168.55.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME /var/www/public/index.php;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param REQUEST_URI $uri;
    }

    # === PHP-FPM handler for direct .php requests (if needed) ===
    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass 192.168.55.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }

    # === FRONTEND (Next.js app proxy) ===
    location / {
        access_log /var/log/nginx/frontend.access.log;
        proxy_pass http://192.168.55.1:3360;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Deny hidden files
    location ~ /\.(?!well-known).* {
        deny all;
    }
}

# === HTTP Redirect to HTTPS ===
server {
    listen 80;
    server_name financeher.ahmard.net;
    access_log /var/log/nginx/redirect.access.log;
    error_log /var/log/nginx/financeher.error.log warn;

    if ($host = financeher.ahmard.net) {
        return 301 https://$host$request_uri;
    }
    return 404;
}